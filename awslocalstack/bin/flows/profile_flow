#!/bin/bash
source awslocalstack/bin/lib/aws_utils

run_profile_flow() {
    log "--- Starting Flow: Profile ---"

    # Resources
    local SRC_BUCKET="my-local-gallery-profile-bucket"
    local DST_BUCKET="my-local-gallery-profile-bucket-thumbnail"
    local TOPIC_NAME="S3-profile-upload-events"
    local Q_LAMBDA="profile-image-process-lambda"
    local Q_THUMB="cloud-gallery-thumbnail-profile-image-upload"
    local LAMBDA_NAME="S3EventProfileThumbnailConsumerLambda"

    # Buckets
    create_bucket $SRC_BUCKET
    set_bucket_cors $SRC_BUCKET

    create_bucket $DST_BUCKET
    set_bucket_public_read $DST_BUCKET # Destino p√∫blico

    # Messaging (SNS + SQS)
    local TOPIC_ARN=$(create_topic $TOPIC_NAME)

    IFS='|' read -r Q_LAMBDA_URL Q_LAMBDA_ARN <<< $(create_queue $Q_LAMBDA)
    IFS='|' read -r Q_THUMB_URL Q_THUMB_ARN <<< $(create_queue $Q_THUMB)

    subscribe_sqs_to_sns $TOPIC_ARN $Q_LAMBDA_URL $Q_LAMBDA_ARN

    # S3 Notifications -> SNS (Original Upload)
    local NOTIF_CONFIG=$(printf '{"TopicConfigurations":[{"Id":"gallery-upload","TopicArn":"%s","Events":["s3:ObjectCreated:*"]}]}' "$TOPIC_ARN")
    awslocal s3api put-bucket-notification-configuration --bucket $SRC_BUCKET --notification-configuration "$NOTIF_CONFIG"

    # S3 Notifications -> SQS (Thumbnail Created)
    local Q_POLICY=$(printf '{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Principal":{"Service":"s3.amazonaws.com"},"Action":"sqs:SendMessage","Resource":"%s","Condition":{"ArnEquals":{"aws:SourceArn":"arn:aws:s3:::%s"}}}]}' "$Q_THUMB_ARN" "$DST_BUCKET")
    awslocal sqs set-queue-attributes --queue-url "$Q_THUMB_URL" --attributes "{\"Policy\": $(echo $Q_POLICY | jq -R .)}"

    awslocal s3api put-bucket-notification-configuration --bucket $DST_BUCKET \
        --notification-configuration "{\"QueueConfigurations\": [{\"Id\": \"thumb-created\",\"QueueArn\": \"$Q_THUMB_ARN\",\"Events\": [\"s3:ObjectCreated:*\"]}]}"

    # Lambda
    local ROLE_ARN=$1 # Passado pelo init
    local ZIP_FILE=$2
    local ENV="Variables={THUMBNAIL_BUCKET_NAME=$DST_BUCKET,THUMBNAIL_WIDTH=80,THUMBNAIL_HEIGHT=80,THUMBNAIL_QUALITY=100}"

    deploy_lambda $LAMBDA_NAME $ROLE_ARN $ZIP_FILE "$ENV"

    # Trigger Lambda
    awslocal lambda create-event-source-mapping --function-name $LAMBDA_NAME --batch-size 1 --event-source-arn $Q_LAMBDA_ARN > /dev/null 2>&1 || true
}