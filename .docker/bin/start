#!/bin/bash

if [ ${0} != ".docker/bin/start" ]; then
  echo "You must run the script from the root folder"
  exit 0
fi

if [ ! -f "api-laravel/vendor/autoload.php" ]; then
    echo "You must install the dependencies first: .docker/bin/install"
    exit 0
fi

source awslocalstack/bin/lib/initialize-aws-arch
source awslocalstack/bin/lib/deploy-development-data

export WWWUSER=${WWWUSER:-$UID}
export WWWGROUP=${WWWGROUP:-$(id -g)}

if docker compose -f awslocalstack/docker-compose.yml up -d --wait; then
  docker compose -f spa-react/docker-compose.yml up -d --wait
  docker compose -f spa-react/docker-compose.yml exec -d spa-react npm run dev -- --host &&
  docker compose -f api-laravel/docker-compose.yml up -d

  initialize_aws_arch
  deploy_development_data
else
  echo "Something went wrong while trying start AWS Localstack related containers"
  docker compose -f awslocalstack/docker-compose.yml logs | tail -n 20
  exit 1
fi